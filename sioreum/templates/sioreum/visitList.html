{% extends 'sioreum/base.html' %}
{% load static %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'sioreum/css/visitList.css' %}">
{% endblock %}

{% block content %}
<div class="mainbox">
    <title>방명록</title>
    <div class="info col-7 offset-2 p-2 mb-4">방명록을 남겨주세요. <br/>
    전화번호를 남겨주신 분에 한하여 추첨을 통해 시오름 굿즈를 배송해 드립니다.
    <br/>입력하신 전화번호는 관리자 외에 열람 불가합니다. 전화번호는 배송 후 폐기됩니다. 
    </div>

    <div class="row justify-content-center">
        {% if visits.number == 1 %}
        <!-- <div class="row"> -->
            <div class="m-3 px-3 pt-3 pb-1 card">
                <textarea class="visitContent" name="" id="" rows="5" placeholder="내용을 적어주세요."></textarea>
                <input class="my-1 number" type="text" placeholder="전화번호 (010-0000-0000)">
                <div class="row row-cols-3 px-3 ">
                    <input class="my-1 author" type="text" placeholder="이름">
                    <img src="static/sioreum/img/flower.png" class="flower" alt="">
                    <button class="my-1 text-right uploadBtn active" type="submit">올리기</button>
                </div>
            </div>
            <div class="visitContainer"></div>
        <!-- </div> -->
        {% else %}        
        {% endif %}
        <!-- TODO: visitContainer ajax wrap, time order change -->
        {% for visit in visits %}
            <div class="m-3 px-3 pt-3 card">
                <div class="overflow-auto visitText">{{ visit.text }}</div>
                <div class="row row-cols-3 px-3 mt-2">
                    <div class="mt-2 author">{{ visit.author }}</div>
                    <img src="static/sioreum/img/flower.png" class="flower" alt="">
                    <div class="mt-2 text-right text-secondary ">{{ visit.created_date|date:"y.m.d"}}</div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        {% if visits.has_other_pages %}
        <ul class="pagination justify-content-center">
            {% if visits.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ visits.previous_page_number }}">&lsaquo;</a></li>
            {% else %}
            <li class="page-item disabled page-link text-dark"><span>&laquo;</span></li>
            <li class="page-item disabled page-link text-dark"><span>&lsaquo;</span></li>
            {% endif %}
            {% for i in visits.paginator.page_range %}
                {% if visits.number == i %}
                    <li class="page-item active page-link black bg-blue"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                {% else %}
                    <li class="page-item"><a class="page-link text-dark" href="?page={{ i }}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}
            {% if visits.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ visits.next_page_number }}">&rsaquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ visits.paginator.num_pages }}">&raquo;</a></li>
            {% else %}
            <li class="page-item disabled page-link text-dark"><span>&rsaquo;</span></li>
            <li class="page-item disabled page-link text-dark"><span>&raquo;</span></li>
            {% endif %}
        </ul>
        {% endif %}
    </div>
</div>




{% comment %} <script src="static/scripts/main.js"></script> {% endcomment %}
{% comment %} <script type="module" src="{% static 'sioreum/js/main.js' %}"></script> {% endcomment %}
<!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
    {% comment %} window.csrfToken = '{{ csrf_token }}' {% endcomment %}

    
<script>

    // const validateComment = () => {
    //     if (!textarea.value || !name) {
    //         btn.classList.remove('active');
    //         return false;
    //     }        
    //     btn.classList.add('active');
    //     return true;
    // }

    const request = new XMLHttpRequest();
    
    
    const onClick = () => {
        const textarea = document.querySelector(".visitContent");
        const namearea = document.querySelector(".author");
        const numberarea = document.querySelector(".number");
        // const timearea = document.getElementsByClassName("createTime");
        const content = textarea.value;
        const name = namearea.value;
        const number = numberarea.value;
        // let date = null;
        // for (var i = 0; i < timearea.length; i++) {
        //     date = timearea[i].value;
        // };
        // const date = timearea.value;
        // -----------------------------------
            
        const url = "/visitor/write/";

        if(!validName()) return
        
        namearea.addEventListener('input', () => {
            if (!namearea.value) {
                btn.classList.remove('active');
                return false;
            }  else {
                btn.classList.add('active');
                return true;         
            }
        })

        request.open("POST", url, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.send(JSON.stringify({ content, name, number }));
        textarea.value = "";
        namearea.value = "";
        numberarea.value = "";
    };

    const btn = document.querySelector(".uploadBtn");
    btn.addEventListener('click', onClick);

    // validName = () => {
    //     if (!namearea.value) {
    //         btn.classList.remove('active');
    //         return false;
    //     }  else {
    //         btn.classList.add('active');
    //         return true;         
    //     }
    // }

    const handleResponse = () => {
        if (request.status <= 400) {
            const { comment, writer, time } = JSON.parse(request.response);         
            const element = document.querySelector(".visitContainer")
            const createVisit = document.createElement("div");
            // const timeFormat = "YY.MM.DD";
            // const timeEdit = moment(time).format(timeFormat);
            createVisit.innerHTML = `
                <div class="m-3 px-3 pt-3 card">
                    <div class="overflow-auto" style="height:130px;">${ comment }</div>
                        <div class="row row-cols-3 px-3 mt-2">
                        <div class="mt-2 author">${ writer }</div>
                        <img src="static/sioreum/img/flower.png" class="flower" alt="">
                        <div class="mt-2 text-right text-secondary" style="height:25px;">${ time } </div>
                    </div>
                </div>
                `;
            // const newComment = createVisit.firstElementChild
            // element.appendChild(newComment);
            element.appendChild(createVisit);
        }
    };
    
    request.onreadystatechange = () => {
        if (request.readyState === XMLHttpRequest.DONE) {
            handleResponse();
        }
    };
</script>


 

 

<!-- TODO: textarea css, pagination edit, ajax time format -->


{% endblock %}

