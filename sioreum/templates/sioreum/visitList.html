{% extends 'sioreum/base.html' %}
{% load static %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'sioreum/css/visitList.css' %}">
{% endblock %}

{% block content %}
<div class="mainbox">
    <title>방명록</title>
    <div class="row justify-content-center mb-3">
        <div class="info col-6 col-xl-5 p-3 ">방명록을 남겨주세요. <br/>
        전화번호를 남겨주신 분에 한하여 추첨을 통해 시오름 굿즈를 배송해 드립니다.
        <br/>입력하신 전화번호는 관리자 외에 열람 불가하며 굿즈 배송 후 폐기됩니다. 
        </div>

    </div>

    <div class="row justify-content-center visitContainer">
        {% if visits.number == 1 %}
            <div class="m-3 px-3 pt-3 pb-1 card">
                <textarea class="visitContent" name="" id="" rows="5" placeholder="내용을 적어주세요."></textarea>
                <input class="my-1 number" type="text" placeholder="전화번호 (010-0000-0000)">
                <div class="row row-cols-3 px-3 ">
                    <input class="my-1 author" type="text" placeholder="이름">
                    <img src="static/sioreum/img/flower.png" class="flower" alt="">
                    <button class="my-1 uploadBtn" type="submit">올리기</button>
                </div>
            </div>
        {% else %}        
        {% endif %}
        {% for visit in visits %}
            <div class="m-3 px-3 pt-3 card">
                <div class="overflow-auto visitText">{{ visit.text }}</div>
                <div class="row row-cols-3 px-3 mt-2">
                    <div class="mt-2 author">{{ visit.author }}</div>
                    <img src="static/sioreum/img/flower.png" class="flower" alt="">
                    <div class="mt-2 text-right text-secondary ">{{ visit.created_date|date:"y.m.d"}}</div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="row mt-2">
    <div class="col-12">
        {% if visits.has_other_pages %}
        <ul class="pagination justify-content-center">
            {% if visits.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ visits.previous_page_number }}">&lsaquo;</a></li>
            {% else %}
            <li class="page-item disabled page-link text-dark"><span>&laquo;</span></li>
            <li class="page-item disabled page-link text-dark"><span>&lsaquo;</span></li>
            {% endif %}
            {% for i in visits.paginator.page_range %}
                {% if visits.number == i %}
                    <li class="page-item active page-link black bg-blue"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                {% else %}
                    <li class="page-item"><a class="page-link text-dark" href="?page={{ i }}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}
            {% if visits.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ visits.next_page_number }}">&rsaquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ visits.paginator.num_pages }}">&raquo;</a></li>
            {% else %}
            <li class="page-item disabled page-link text-dark"><span>&rsaquo;</span></li>
            <li class="page-item disabled page-link text-dark"><span>&raquo;</span></li>
            {% endif %}
        </ul>
        {% endif %}
    </div>
</div>




{% comment %} <script src="static/scripts/main.js"></script> {% endcomment %}
{% comment %} <script type="module" src="{% static 'sioreum/js/main.js' %}"></script> {% endcomment %}
<!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
    {% comment %} window.csrfToken = '{{ csrf_token }}' {% endcomment %}

    
<script>
    const request = new XMLHttpRequest();
    
    const btn = document.querySelector(".uploadBtn");

    const textarea = document.querySelector(".visitContent");
    const namearea = document.querySelector(".author");
    const numberarea = document.querySelector(".number");
    
    const validText = () => {
        if (namearea.value && textarea.value) {
            btn.classList.add('active');
            // btn.disabled=false;
            return true;           
        } if (!textarea.value) {
            alert("내용을 작성해주세요.")
            btn.classList.remove('active');
            // btn.disabled=true;
            return false;
        } 
    }
    
    const validName = () => {
        if (namearea.value && textarea.value) {
            btn.classList.add('active');
            return true;        
        } if (!namearea.value) {
            btn.classList.remove('active');
            alert("이름을 작성해주세요.")
            return false;
        }             
    }

    btn.addEventListener('click', () => {
        onClick();
    })

    textarea.addEventListener('input', () => {
        validText();
    })
    
    namearea.addEventListener('input', () => {
        validName();
    })
    
    const onClick = () => {
        if(!validText() && !validName()) return
        const content = textarea.value;
        const name = namearea.value;
        const number = numberarea.value;
        const url = "/visitor/write/";
        request.open("POST", url, true);
        request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        request.send(JSON.stringify({ content, name, number }));
        textarea.value = ""; 
        namearea.value = ""; 
        numberarea.value = "";
    };


    const handleResponse = () => {
        if (request.status <= 400) {
            const { comment, writer, time } = JSON.parse(request.response);         
            const element = document.querySelector(".visitContainer")
            const createVisit = document.createElement("div");
            const dateTime = new Date(time) 
            const newTime = dateTime.toLocaleDateString('en-US', {year: '2-digit'}) + "." +
                            dateTime.toLocaleDateString('en-US', {month: '2-digit'}) + "." +
                            dateTime.toLocaleDateString('en-US', {day: '2-digit'}) 
          
            createVisit.innerHTML = `
                <div class="m-3 px-3 pt-3 card">
                    <div class="overflow-auto" style="height:130px;">${ comment }</div>
                        <div class="row row-cols-3 px-3 mt-2">
                        <div class="mt-2 author">${ writer }</div>
                        <img src="static/sioreum/img/flower.png" class="flower" alt="">
                        <div class="mt-2 text-right text-secondary" style="height:25px;">${ newTime } </div>
                    </div>
                </div>
                `;
            element.insertBefore(createVisit, element.children[1]);
            console.log(element.children[8]);
            element.children[8].hidden=true;
        }
    };
            {% comment %} const pageBtn = document.querySelector(".pagination");
            const page2Btn = pageBtn.children[3];
            const clickPage2 = () => {
                element.children[8].hidden=false;
            } 
            page2Btn.addEventListener('click', clickPage2()); {% endcomment %}
            

    
    request.onreadystatechange = () => {
        if (request.readyState === XMLHttpRequest.DONE) {
            handleResponse();
        }
    };
</script>


{% endblock %}

